{% extends 'base.html' %}
    {% block css %}
        <style>
            #div_digg {
                float: right;
                margin-bottom: 10px;
                margin-right: 30px;
                font-size: 12px;
                width: 125px;
                text-align: center;
                margin-top: 10px;
                }
            .diggit {
                    float: left;
                    width: 46px;
                    height: 52px;
                    background: url(//assets.cnblogs.com/images/upup.gif) no-repeat;
                    text-align: center;
                    cursor: pointer;
                    margin-top: 2px;
                    padding-top: 5px;
                }
            .buryit {
                    float: right;
                    margin-left: 20px;
                    width: 46px;
                    height: 52px;
                    background: url(//assets.cnblogs.com/images/downdown.gif) no-repeat;
                    text-align: center;
                    cursor: pointer;
                    margin-top: 2px;
                    padding-top: 5px;
                }
            .clear {
                    clear: both;
                }
            .diggword {
                margin-top: 5px;
                margin-left: 0;
                font-size: 12px;
                color: #808080;
            }
            .diggnum {
                font-size: 14px;
                color: #075db3;
                font-family: Verdana;
            }
            .burynum {
                font-size: 14px;
                color: #075db3;
                font-family: Verdana;
            }
        </style>
    {% endblock %}
{% block content %}
    <h1 class="text-center">{{ article_obj.title }}</h1>
    {{ article_obj.content|safe }}
    {#点赞点踩开始#}
    <div class="clearfix">
    <div id="div_digg">
    <div class="diggit action" onclick="votePost(19516100,'Digg')">
        <span class="glyphicon glyphicon-thumbs-up"></span>
        <span class="diggnum A" id="digg_count">{{ article_obj.up_num }}</span>
    </div>
    <div class="buryit action" onclick="votePost(19516100,'Bury')">
        <span class="glyphicon glyphicon-thumbs-down"></span>
        <span class="burynum A" id="bury_count">{{ article_obj.down_num }}</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips"></div>
    </div>
    </div>
    {#点赞点踩结束#}
    {#评论开始#}
        {% if request.user.is_authenticated %}
            <div>
                <p><span class="glyphicon glyphicon-comment">评论列表</span></p>
                <ul class="list-group">
                    {% for comment in comment_list %}
                    	<li class="list-group-item">
                            <span>#{{ forloop.counter }}楼</span>
                            <span>{{ comment.comment_time|date:'Y-m-d h:i:s' }}</span>
                            <span>{{ comment.user.username }}</span>
                            <span>
                                <a class="pull-right reply"
                                   username="{{ comment.user.username }}" comment_id="{{ comment.id }}"
                                    style="cursor: pointer">
                                    回复
                                </a>
                            </span>
                            <div>
                                {{ comment.content }}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div><span class="glyphicon glyphicon-comment">发表评论</span></div>
                <div>
                    <textarea name="" id="comment" cols="50" rows="10"></textarea>
                </div>
            <button id="btn" class="btn btn-primary">提交评论</button>
        {% else %}
                <p><span class="glyphicon glyphicon-comment">登录之后才能查看</span>
                立即<a href="/login/">登录</a>或者<a href="/home/">逛逛首页</a></p>
        {% endif %}
    {#评论结束#}
{% endblock %}
{% block js %}
    <script>
        let parentId = null
        $('.action').click(function () {
            let is_up = $(this).hasClass('diggit')
            let $div = $(this)
            $.ajax({
                url :'/up_or_down/',
                type :'post',
                data :{
                    'article_id':'{{ article_obj.id }}',
                    'is_up' :is_up,
                    csrfmiddlewaretoken :'{{ csrf_token }}',
                },
                success:function (args) {
                    if(args.code===0){
                        $('#digg_tips').text(args.msg)
                        let oldNum = $div.children().text()
                        $div.children('.A').text(Number(oldNum) + 1)
                    }else if(args.code === 1001){
                        $('#digg_tips').html(args.msg)
                        let oldNum = $div.children().text()
                        $div.children('.A').text(Number(oldNum) - 1)
                    }else if(args.code === 1008){
                        $('#digg_tips').html(args.msg)
                    }
                    else if(args.code === 1000){
                        $('#digg_tips').html(args.msg)
                    }
                    else{
                        $('#digg_tips').html(args.msg)
                    }
                }
            })
        })
        $('#btn').click(function () {
            let content = $('#comment').val();
            $.ajax({
                url:'/comment/',
                type:'post',
                data:{
                    'article_id': {{ article_obj.id }},
                    'content': content,
                    'parent_id': parentId,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function (args) {
                    let username ='{{ request.user.username }}'
                    let temp = `
                        <li class="list-group-item">
                            <span>${username}</span>
                            <div>
                                ${content}
                            </div>
                        </li>
                    `
                    $('.list-group').append(temp)
                }
            })
        })
        $('.reply').click(function () {
            let commentUsername = $(this).attr('username')
            parentId = $(this).attr('comment_id')
            $('#comment').val('@'+commentUsername+'\n').focus()
        })
    </script>
{% endblock %}